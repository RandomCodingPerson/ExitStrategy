<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>

        <script>
            sessionStorage.setItem("board", "{}");
        </script>
        
        <div class="ui">
            <!-- board setup -->

            <div class="pieceMove">
                <h1>Move Pieces</h1>
                <p>Piece</p>
                <textarea id='pc' class="pieceChoice"></textarea>
                <p>Square</p>
                <textarea id='sc' class="pieceChoice"></textarea>


                <button id='pm' class='gb' >Move Piece</button>
                <script>
                    cols = ["A", "B", "C", "D", "E", "F", "G"];
                    document.getElementById("pm").onclick = () => {
                        piece = document.getElementById("pc").value;
                        square = document.getElementById("sc").value;
                        console.log("pc", piece, square)
                        if (!piece || !square) {
                            alert("Please enter a piece and square");
                            return;
                        }
                        board = JSON.parse(sessionStorage.getItem("board"));
                        console.log('b', board)
                        console.log()
                        if (!Object.keys(board).includes(piece)) {
                            alert("Not a valid piece!");
                            return;
                        }
                        subSquare = square.split("");
                        console.log('ss', subSquare)
                        let column = cols.indexOf(subSquare[0]);
                        let row = 7 - parseInt(subSquare[1]);

                        movePiece(piece, row, column);

                    }
                </script>
            </div>

            <div id="board" class="board">
                
                <script>
                    cols = ["A", "B", "C", "D", "E", "F", "G"];
                    
                    board = document.getElementById("board");
                    for (i = 0; i<7; i++) {
                        for (j = 0; j<7; j++) {
                            squareId = `${cols[i]}${j+1}`
                            square = document.createElement("div");
                            square.classList.add("square");
                            square.id = squareId;
                            square.style.gridColumn = i+1;
                            square.style.gridRow = j + 1;
                            board.appendChild(square);
                        }
                    }
                </script>
            </div>
            <div class="textInput">
                <h1>Input</h1>
                <textarea id='pgn' class="pgnInput"></textarea>
                <button id='gb' class='gb' >Generate board</button>
                <script>
                    document.getElementById("gb").onclick = () => {
                        let pgn = processPgn(document.getElementById("pgn").value);
                        genPieces(pgn);
                        let board = sessionStorage.setItem("board", JSON.stringify(pgn));
                        console.log(board);
                    }
                </script>
            </div>
        </div>

        <!-- piece setup -->
        <script>
            function removePieces() {
                var paras = document.getElementsByClassName('piece');

                while(paras[0]) {
                    paras[0].parentNode.removeChild(paras[0]);
                }
            }

            function removeDots() {
                var paras = document.getElementsByClassName('dot');

                while(paras[0]) {
                    paras[0].parentNode.removeChild(paras[0]);
                }
            }

            function genPieces(pieces) {

                removePieces();
                cols = ["A", "B", "C", "D", "E", "F", "G"];
                board = document.getElementById("board");

                for (let i = 0; i<Object.keys(pieces).length; i++) {
                    console.log("test")
                    let x= Object.values(pieces)[i];
                    pieceId = `p${cols[x["column"]]}${x["row"]+1}`
                    piece = document.createElement("div");
                    piece.classList.add(`${x["side"]}`);
                    piece.classList.add(`piece`);
                    piece.id = pieceId;
                    piece.style.gridRow = x["row"] + 1;
                    piece.style.gridColumn = x["column"] + 1;
                    piece.innerText=x["piece"];

                    piece.addEventListener( "click",  () => {
                        genDots(pieces, [x["row"], x["column"]], Object.keys(pieces)[i]);
                    });

                    board.appendChild(piece);
                }
            }

            function genDots(board, square, piece) {

                console.log('td', square, board)

                removeDots();

                console.log('b', board, square, piece)

                // square: [rowNum, colNum]

                let pieceRow = square[0];
                let pieceColumn = square[1];

                let occupied = Object.values(board).map((x) => {
                    return [x["row"], x["column"]]
                });

                console.log("o", occupied)

                occupied.push([3, 0]);
                occupied.push([3, 6]);

                let dots = [
                    [],
                    [],
                    [],
                    []
                ]

                for (let i=pieceRow; i>=0; i--) {
                    console.log("TEST1", [i, pieceColumn])

                    if (i == pieceRow) {
                        continue;
                    } else if (occupied.contains([i, pieceColumn])) {
                        dots[0] = (![i + 1, pieceColumn].compare(square)) ? [i + 1, pieceColumn] : ([]);
                        break;
                    } else if (i == 0) {
                        dots[0] = [i, pieceColumn];
                        break;
                    }
                }

                for (let i = pieceRow; i<=6; i++) {
                    if (i == pieceRow) {
                        continue;
                    } else if (occupied.contains([i, pieceColumn])) {
                        dots[1] = (![i - 1, pieceColumn].compare(square)) ? [i - 1, pieceColumn] : ([]);
                        break;
                    } else if (i == 6) {
                        dots[1] = [i, pieceColumn]
                        break;
                    }
                }

                for (let i = pieceColumn; i>=0; i--) {
                    if (i == pieceColumn) {
                        continue;
                    } else if (occupied.contains([pieceRow, i])) {
                        dots[2] = (![pieceRow, i + 1].compare(square)) ? [pieceRow, i + 1] : ([]);
                        break;
                    } else if (i == 0) {
                        dots[2] = [pieceRow, i];
                        break;
                    }
                }

                for (let i = pieceColumn; i<=6; i++) {
                    if (i == pieceColumn) {
                        continue;
                    } else if (occupied.contains([pieceRow, i])) {
                        dots[3] = (![pieceRow, i - 1].compare(square)) ? [pieceRow, i - 1] : ([]);
                        break;
                    } else if (i == 6) {
                        dots[3] = [pieceRow, i];
                        break;
                    }
                }

                for (let j = 0; j<dots.length; j++) {
                    console.log("hi", dots[j])
                    let dotCoords = dots[j];

                    if (dotCoords.length == 0) {
                        continue;
                    } else {
                        let dot = document.createElement("div");
                        dot.classList.add("dot");
                        dot.style.gridRow = dotCoords[0] + 1;
                        dot.style.gridColumn = dotCoords[1] + 1;

                        document.getElementById("board").appendChild(dot);
                        
                        dot.onclick = () => {
                            removeDots();
                            movePiece(piece, dotCoords[0], dotCoords[1]);
                        }
                    }
                    
                }
            }

            function movePiece(piece, row, column) {

                board = JSON.parse(sessionStorage.getItem("board"));

                console.log("ss", sessionStorage.getItem("board"), board)

                board[piece]["row"] = row;
                board[piece]["column"] = column;

                sessionStorage.setItem("board", JSON.stringify(board));
                
                genPieces(board);

                if (piece.split("")[1] == "W" && square.compare([3,3])) {
                    alert("White won!")
                };

                if (piece.split("")[1] == "B" && square.compare([3,3])) {
                    alert("Black won!")
                };
            }

            function processPgn(gbString) {
                // gbString = "1W-A2 2W-A3" etc.
                let gbArray = gbString.split(" "); 
                let returnPgn = {};
                for (let i = 0; i < gbArray.length; i++) {
                    let thisPieceArray = gbArray[i].split("-");
                    let thisPiece = thisPieceArray[0];
                    let thisPieceNum = parseInt(thisPiece.split("")[0]);
                    let thisPieceSide = (thisPiece.split("")[1] == "W") ? "white" : "black";

                    let thisSquare = thisPieceArray[1];

                    cols = ["A", "B", "C", "D", "E", "F", "G"];
                    let thisColumn = cols.indexOf(thisSquare.split("")[0]);
                    let thisRow = 7 - thisSquare.split("")[1];

                    console.log('tr', thisRow)

                    let thisPieceDetails = {
                        "row": thisRow, 
                        "column": thisColumn,
                        "piece": thisPieceNum,
                        "side": thisPieceSide
                    }
                    returnPgn[thisPiece] = thisPieceDetails;
                }
                return returnPgn;
            }


        </script>


        <script>
            // (honors math) methods
            Object.prototype.compare = function(o){
                var ok = Object.keys(this);
                return typeof o === "object" && ok.length === Object.keys(o).length ? ok.every(k => this[k] === o[k]) : false;
            };
            Array.prototype.compare = function(a){
                return this.every((e,i) => typeof a[i] === "object" ? a[i].compare(e) : a[i] === e);
            };
            Array.prototype.contains = function(o){
                return this.some(e => typeof o === "object" ? o.compare(e) : o === e);
            }
        </script>

    </body>
</html>